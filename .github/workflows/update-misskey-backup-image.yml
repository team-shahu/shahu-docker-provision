name: Update Misskey Backup Image

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current image info
        id: current
        run: |
          # compose.yamlã‹ã‚‰ç¾åœ¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—
          CURRENT_LINE=$(grep "ghcr.io/team-shahu/misskey-backup" compose.yaml)
          echo "current_line=$CURRENT_LINE" >> $GITHUB_OUTPUT
          echo "Current line from compose.yaml: $CURRENT_LINE"
          
          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’æŠ½å‡º
          CURRENT_VERSION=$(echo "$CURRENT_LINE" | sed -n 's/.*misskey-backup:\([^@]*\)@.*/\1/p')
          CURRENT_FULL_DIGEST=$(echo "$CURRENT_LINE" | sed -n 's/.*@\(sha256:[a-f0-9]*\).*/\1/p')
          CURRENT_DIGEST=$(echo "$CURRENT_FULL_DIGEST" | sed 's/sha256://')
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "current_digest=$CURRENT_DIGEST" >> $GITHUB_OUTPUT
          echo "current_full_digest=$CURRENT_FULL_DIGEST" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          echo "Current digest: $CURRENT_DIGEST"
          echo "Current full digest: $CURRENT_FULL_DIGEST"

      - name: Get latest image info
        id: latest
        run: |
          # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰æœ€æ–°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—
          # ã¾ãšã€åˆ©ç”¨å¯èƒ½ãªå…¨ã¦ã®ã‚¿ã‚°ã‚’å–å¾—
          TOKEN=$(curl -s "https://ghcr.io/token?scope=repository:team-shahu/misskey-backup:pull" | jq -r .token)
          TAGS=$(curl -s -H "Authorization: Bearer $TOKEN" "https://ghcr.io/v2/team-shahu/misskey-backup/tags/list" | jq -r '.tags[]' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          
          echo "Latest tag: $TAGS"
          LATEST_VERSION="$TAGS"
          
          # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å®Œå…¨ãªãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’å–å¾—
          FULL_DIGEST=$(docker buildx imagetools inspect "ghcr.io/team-shahu/misskey-backup:$LATEST_VERSION" --format "{{json .Manifest}}" | jq -r '.digest')
          LATEST_DIGEST=$(echo "$FULL_DIGEST" | sed 's/sha256://')
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "latest_digest=$LATEST_DIGEST" >> $GITHUB_OUTPUT
          echo "latest_full_digest=$FULL_DIGEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST_VERSION"
          echo "Latest digest: $LATEST_DIGEST"
          echo "Latest full digest: $FULL_DIGEST"

      - name: Check for updates
        id: check
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.current_version }}"
          CURRENT_DIGEST="${{ steps.current.outputs.current_digest }}"
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"
          LATEST_DIGEST="${{ steps.latest.outputs.latest_digest }}"
          
          echo "=== Comparing versions and digests ==="
          echo "  Current version: $CURRENT_VERSION"
          echo "  Latest version:  $LATEST_VERSION"
          echo "  Current digest:  $CURRENT_DIGEST"
          echo "  Latest digest:   $LATEST_DIGEST"
          echo ""
          
          UPDATE_NEEDED=false
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "âœ“ Version mismatch detected: $CURRENT_VERSION -> $LATEST_VERSION"
            UPDATE_NEEDED=true
          else
            echo "âœ“ Version is up to date: $CURRENT_VERSION"
          fi
          
          if [ "$CURRENT_DIGEST" != "$LATEST_DIGEST" ]; then
            echo "âœ“ Digest mismatch detected"
            echo "  Current: $CURRENT_DIGEST"
            echo "  Latest:  $LATEST_DIGEST"
            UPDATE_NEEDED=true
          else
            echo "âœ“ Digest is up to date"
          fi
          
          echo ""
          if [ "$UPDATE_NEEDED" = true ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Update available!"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date"
          fi

      - name: Update compose.yaml
        if: steps.check.outputs.update_available == 'true'
        run: |
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"
          FULL_DIGEST="${{ steps.latest.outputs.latest_full_digest }}"
          
          # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸è¡Œã‚’ä½œæˆ
          NEW_LINE="    image: ghcr.io/team-shahu/misskey-backup:${LATEST_VERSION}@${FULL_DIGEST}"
          
          # compose.yamlã‚’æ›´æ–°
          sed -i "s|.*ghcr.io/team-shahu/misskey-backup.*|${NEW_LINE}|" compose.yaml
          
          echo "Updated compose.yaml"
          echo "New image reference: ${NEW_LINE}"
          
          # å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
          echo "--- Git diff ---"
          git diff compose.yaml

      - name: Create Pull Request
        if: steps.check.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update misskey-backup to ${{ steps.latest.outputs.latest_version }}"
          title: "chore: Update misskey-backup to ${{ steps.latest.outputs.latest_version }}"
          body: |
            ## ğŸ”„ Misskey Backup ã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ›´æ–°
            
            ã“ã®PRã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            
            ### ğŸ“‹ å¤‰æ›´å†…å®¹
            | é …ç›® | å¤ã„ã® | æ–°ã—ã„ã® |
            |------|------|--------|
            | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | `${{ steps.current.outputs.current_version }}` | `${{ steps.latest.outputs.latest_version }}` |
            | ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ | `${{ steps.current.outputs.current_digest }}` | `${{ steps.latest.outputs.latest_digest }}` |
            
            ### ğŸ” è©³ç´°
            
            **ä»¥å‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸:**
            ```
            ghcr.io/team-shahu/misskey-backup:${{ steps.current.outputs.current_version }}@${{ steps.current.outputs.current_full_digest }}
            ```
            
            **æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸:**
            ```
            ghcr.io/team-shahu/misskey-backup:${{ steps.latest.outputs.latest_version }}@${{ steps.latest.outputs.latest_full_digest }}
            ```
            
            ### âœ… ç¢ºèªäº‹é …
            - [ ] å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ
            - [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã—ãŸï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            - [ ] æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨æº–å‚™ãŒã§ãã¦ã„ã¾ã™
            
            ### ğŸ“š é–¢é€£ãƒªãƒ³ã‚¯
            - [misskey-backup ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/team-shahu/misskey-backup)
            - [ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒª](https://github.com/team-shahu/misskey-backup/pkgs/container/misskey-backup)
            
            ---
            
            ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPR | ğŸ“… ${{ github.run_id }}
          branch: update-misskey-backup-${{ steps.latest.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            automated pr
